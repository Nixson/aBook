<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div id="bookList" class="container-fluid">
    <h1>Телефонный справочник</h1>
    <div class="text-right" id="authInfo"><h4></h4></div>
    <div class="alert alert-danger hidden" id="load-error"></div>
    <div class="row">
        <div class="col-sm-1">
            <button class="btn btn-success btn-block action" data-action="add">Добавить</button>
        </div>
        <div class="col-sm-7">
            <input type="text" class="form-control" id="find" />
        </div>
        <div class="col-sm-2">
            <button class="btn btn-success btn-block action" data-action="loadData">Искать</button>
        </div>
        <div class="col-sm-2">
            <button class="btn btn-danger btn-block action" data-action="clearData">Очистить</button>
        </div>
    </div>
    <table class="table">
        <thead>
        <tr>
            <th>Фамилия</th>
            <th>Имя</th>
            <th>Отчество</th>
            <th>Дата рождения</th>
            <th>e-mail</th>
            <th>Телефон</th>
        </tr>
        </thead>
        <tbody id="bookListTable"></tbody>
    </table>
</div>
<div class="modal fade" tabindex="-1" role="dialog" id="auth">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Авторизация</h4>
            </div>
            <form class="form-horizontal">
            <div class="modal-body">
                <div class="form-group">
                    <label for="auth-login" class="col-sm-2 control-label">Логин</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="auth-login" placeholder="Логин">
                    </div>
                </div>
                <div class="form-group">
                    <label for="auth-pass" class="col-sm-2 control-label">Пароль</label>
                    <div class="col-sm-10">
                        <input type="password" class="form-control" id="auth-pass" placeholder="Пароль">
                    </div>
                </div>
                <div class="alert alert-danger hidden" id="auth-error"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary action" data-action="login">Войти</button>
            </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="edit">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title"></h4>
            </div>
            <form class="form-horizontal">
                <div class="modal-body">
                    <div class="form-group" id="show-login">
                        <label for="login" class="col-sm-3 control-label">Логин</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="login" placeholder="Логин">
                        </div>
                    </div>
                    <div class="form-group" id="show-password">
                        <label for="password" class="col-sm-3 control-label">Пароль</label>
                        <div class="col-sm-9">
                            <input type="password" class="form-control" id="password" placeholder="Пароль">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="surname" class="col-sm-3 control-label">Фамилия</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="surname" placeholder="Фамилия">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="firstname" class="col-sm-3 control-label">Имя</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="firstname" placeholder="Имя">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="middlename" class="col-sm-3 control-label">Отчество</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="middlename" placeholder="Отчество">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="birthday" class="col-sm-3 control-label">Дата рождения</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="birthday" placeholder="Дата рождения">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="email" class="col-sm-3 control-label">e-mail</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="email" placeholder="e-mail">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="phone" class="col-sm-3 control-label">Телефон</label>
                        <div class="col-sm-9">
                            <input type="text" class="form-control" id="phone" placeholder="Телефон">
                        </div>
                    </div>
                    <div class="alert alert-danger hidden" id="edit-error"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary action" data-action="save">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="js/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="js/bootstrap.min.js"></script>
<script type="application/x-javascript">
    $(function(){
        form.init();
    });
    var form = (function(){
        var self = this;
        self.domain = "http://localhost:8999/restBook";
        self.domain = "http://localhost:8081/jbook";
        self.client;
        self.list = [];
        self.tpl = '<tr><td>#surname#</td>' +
            '<td>#firstname#</td>' +
            '<td>#middlename#</td>' +
            '<td>#birthday#</td>' +
            '<td>#email#</td>' +
            '<td>#phone#</td>' +
            '<td><button class="btn btn-info action" data-action="edit" data-attr="#identifier#">изменить</button></td>' +
            '<td><button class="btn btn-warning action" data-action="rm" data-attr="#identifier#">удалить</button></td>' +
            '</tr>';
        self.init = function(){
            var client = self.getCookie('client');
            if(client != undefined) {
                self.client = JSON.parse(client);
                self.loadData();
            }
            else {
                $('#bookList').addClass("hidden");
                $('#auth').modal('show');
                $('#auth-login').val('');
                $('#auth-pass').val('');
            }
            $('#auth').on('hidden.bs.modal', function (e) {
                if(self.client == undefined || self.client == null){
                    setTimeout(function(){
                        self.exit();
                    },500);
                }
            });
            $(document).on('click','.action',function(){
                var el = $(this).data('action');
                var attr = $(this).data('attr');
                if( typeof form[el]=='function'){
                    form[el](attr);
                }
            });
        };
        self.eClient = {};
        self.save = function(){
            for(var el in self.eClient){
                if(el=="id") continue;
                var _this = $('#'+el);
                if(_this!=null && typeof _this.val == 'function'){
                    self.eClient[el] = _this.val();
                }
            }
            self.post(self.domain+'/usr/add',JSON.stringify(self.eClient),function(){
                self.loadData();
            });
        };
        self.add = function(){
            $('#edit').modal('show');
            self.eClient = {
                surname: null,
                firstname: null,
                middlename: null,
                login: null,
                password: null,
                birthday: null,
                email: null,
                phone: null
            };
            $('#edit form')[0].reset();
            $('#edit h4').text('Новая запись');
            $('#login').attr('disabled',false);
            $('#show-password').removeClass("hidden");
        };
        self.edit = function(id){
            $('#edit').modal('show');
            $('#edit form')[0].reset();
            var map = null;
            for(var el in self.list){
                if(self.list[el].identifier==id){
                    map = self.list[el];
                    break;
                }
            }
            if(map!=null){
                self.eClient = map;
                $('#login').attr('disabled',true);
                $('#show-password').addClass("hidden");
                var name = map.surname+" "+map.firstname+" "+map.middlename;
                $('#edit h4').text(name);
                for(var el in map){
                    var _this = $('#'+el);
                    if(_this!=null && typeof _this.val == 'function'){
                        _this.val(map[el]);
                    }
                }
            }
        };
        self.rm = function(id){
            if(confirm("Вы уверены?")){
                self.get(self.domain+'/rm/'+id,'',function(){
                    self.loadData();
                });
            };
        };
        self.login = function(){
            var auth = {
                login: $('#auth-login').val(),
                pass: $('#auth-pass').val()
            }
            self.post(self.domain+'/auth/token',JSON.stringify(auth),function(resp){
                if(resp.error != undefined) {
                    $('#auth-error').removeClass("hidden").text(resp.data);
                    return;
                }
                self.client = resp.data;
                self.client.token = resp.request.getResponseHeader("Authorization");
                self.setCookie("client",JSON.stringify(self.client),{expires:3600, path:"/"});
                $('#authInfo h4').html(self.client.surname+" "+self.client.firtsname+" "+self.client.middlename+" <strong class='action' data-action='exit'>Выход</strong>")
                $('#auth').modal('hide');
                $('#bookList').removeClass("hidden");
                self.loadData();
            });
        };
        self.clearData = function(){
            $('#find').val('');
            self.loadData();
        };
        self.loadData = function(){
            self.post(self.domain+'/usr',JSON.stringify({find: $('#find').val()}),function(resp){
                console.log(resp);
                $('#bookListTable').text('');
                if(resp.error != undefined){
                    if(resp.data == "Ошибка авторизации"){
                        self.exit();
                    } else {
                        $('#load-error').removeClass("hidden").text(resp.data);
                    }
                    return;
                }
                var list = [];
                self.list = resp.data;
                for(var el in self.list){
                    var elContent = self.tpl;
                    for(var sub in self.list[el]){
                        elContent = elContent.split("#"+sub+"#").join(self.list[el][sub]);
                    }
                    list.push(elContent);
                }
                $('#bookListTable').html(list.join(''));

            });
        };
        self.ajax = function(url,type,data,callback){
            var headers = {'Content-Type':'application/json; charset=UTF-8'};
            if(self.client != null && self.client.token!=undefined)
                headers.Authorization = self.client.token;
            $.ajax({
                headers: headers,
                url: url,
                type: type,
                data: data,
                success: function (result,textStatus,resp) {
                    console.log("success",textStatus,result,resp);
                    callback({success: true, data: result, request: resp});
                },
                error: function (result,textStatus) {
                    console.log("error",textStatus,result);
                    callback({error: true, data: result.responseText, request: result});
                },
                complete: function(xhr,status){
                    console.log("complete",status,xhr);
                }
            });
        }
        self.get = function(url,data,callback){
            self.ajax(url,'GET',data,callback);
        };
        self.post = function(url,data,callback){
            self.ajax(url,'POST',data,callback);
        };
        self.exit = function(){
            self.client = null;
            $('#bookList').addClass("hidden");
            $('#auth').modal('show');
            $('#auth-login').val('');
            $('#auth-pass').val('');
        };
        self.getCookie = function(name) {
            var matches = document.cookie.match(new RegExp(
                "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
            ));
            return matches ? decodeURIComponent(matches[1]) : undefined;
        };
        self.setCookie = function(name, value, options) {
            options = options || {};

            var expires = options.expires;

            if (typeof expires == "number" && expires) {
                var d = new Date();
                d.setTime(d.getTime() + expires * 1000);
                expires = options.expires = d;
            }
            if (expires && expires.toUTCString) {
                options.expires = expires.toUTCString();
            }

            value = encodeURIComponent(value);

            var updatedCookie = name + "=" + value;

            for (var propName in options) {
                updatedCookie += "; " + propName;
                var propValue = options[propName];
                if (propValue !== true) {
                    updatedCookie += "=" + propValue;
                }
            }

            document.cookie = updatedCookie;
        };
        return self;
    })();
</script>
</body>
</html>